<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
    <link href="static/index/css.css" rel="stylesheet" />
    <script src="static/index/jquery-1.7.1.min.js"></script>
    <script src="static/index/iscroll.js"></script>
    <script type="text/javascript">
        TimeToDate = function (a) {
            var d, e, f, g, h, i, j, b = Math.round((new Date).getTime() / 1e3),
            c = b - a;
            return 60 > c ? '<span class="f-coa">刚刚</span>' : 3600 > c ? '<span class="f-cog">' + Math.floor(c / 60) + " 分钟前</span>" : 86400 > c ? '<span class="f-coa">' + Math.floor(c / 3600) + " 小时前</span>" : (d = new Date(1e3 * a), e = d.getHours(), f = d.getFullYear(), g = d.getMinutes(), h = d.getMonth() + 1, i = d.getDate(), 10 > h && (h = "0" + h), 10 > i && (i = "0" + i), 10 > e && (e = "0" + e), 10 > g && (g = "0" + g), j = f + "-" + h + "-" + i + " " + e + ":" + g)
        };
        var scrollviews, views_time, pullDownEl, pullDownOffset, generatedCount = 0;
        function fasong() {
            var text = $(".views_text input").val();
            time();
            $('<div class="views_time"> ' + views_time + '</div><div class="views_2"> <dl> <dt>我：</dt> <dd><em></em>' + text + '</dd> </dl> </div> <div class="clear"></div>').appendTo("#liaotian");
            $(".views_text input").val("");
            setTimeout(function () { scrollviews.refresh(); }, 200);
            setTimeout(function () { scrollviews.scrollToElement('div.clear:last-child', 0); }, 210);
        }
        function time() {
            dateTime = new Date();
            var hh = dateTime.getHours();
            var mm = dateTime.getMinutes();
            var ss = dateTime.getSeconds();
            var yy = dateTime.getFullYear();
            var MM = dateTime.getMonth() + 1;  //因为1月这个方法返回为0，所以加1
            var dd = dateTime.getDate();
            views_time = hh + ':' + mm;
        }
        setTimeout(time, 1000);
        /*function bb(){
            $(".views_btn input").trigger("click");
            }
        setInterval(bb,5000);*/
        function pullDownAction() {
            setTimeout(function () {	// <-- Simulate network congestion, remove setTimeout from production!
                var el, div_time, i, div_l;
                el = document.getElementById('viewsWrapper');
                //$("#liaotian").prepend('<div class="views_time">17:08</div><div class="views_1"><dl><dt>智慧高速客服：</dt><dd><em></em>您好！智慧高速客服人员正为您服务！</dd></dl></div><div class="clear"></div>');
                scrollviews.refresh();		// Remember to refresh when contents are loaded (ie: on ajax completion)
            }, 0);	// <-- Simulate network congestion, remove setTimeout from production!
        }
        function loaded() {
            pullDownEl = document.getElementById('pullDown');
            pullDownOffset = pullDownEl.offsetHeight;
            scrollviews = new iScroll('viewsWrapper', {
                useTransition: true,
                topOffset: pullDownOffset,
                onRefresh: function () {
                    if (pullDownEl.className.match('loading')) {
                        pullDownEl.className = '';
                        pullDownEl.querySelector('.pullDownLabel').innerHTML = '';
                    }
                },
                onScrollMove: function () {
                    if (this.y > 5 && !pullDownEl.className.match('flip')) {
                        pullDownEl.className = 'flip';
                        pullDownEl.querySelector('.pullDownLabel').innerHTML = '';
                        this.minScrollY = 0;
                    } else if (this.y < 5 && pullDownEl.className.match('flip')) {
                        pullDownEl.className = '';
                        pullDownEl.querySelector('.pullDownLabel').innerHTML = '';
                        this.minScrollY = -pullDownOffset;
                    }
                },
                onScrollEnd: function () {
                    if (pullDownEl.className.match('flip')) {
                        pullDownEl.className = 'loading';
                        pullDownEl.querySelector('.pullDownLabel').innerHTML = 'Loading...';
                        pullDownAction();	// Execute custom function (ajax call?)
                    }
                }
            });
            setTimeout(function () { document.getElementById('liaotian').style.left = '0'; }, 800);
        }
        document.addEventListener('touchmove', function (e) { e.preventDefault(); }, false);
        document.addEventListener('DOMContentLoaded', function () { setTimeout(loaded, 200); }, false);
    </script>
</head>
<body>
    <div class="main">
        <div class="hudong_tit">这就是个帖子</div>
        <div class="views" id="viewsWrapper">
            <div id="viewsScroller">
                <div id="pullDown">
                    <span class="pullDownIcon"></span><span class="pullDownLabel"></span>
                </div>
                <div id="liaotian">
                    <!--<div class="views_time">17:08</div>
                    <div class="views_1">
                        <dl>
                            <dt>智慧高速客服：</dt>
                            <dd><em></em>您好！智慧高速客服人员正为您服务！</dd>
                        </dl>
                    </div>
                    <div class="clear"></div>
                    <div class="views_time">17:08</div>
                    <div class="views_2">
                        <dl>
                            <dt>我：</dt>
                            <dd><em></em>请问……</dd>
                        </dl>
                    </div>-->
                    <div class="clear"></div>
                </div>
            </div>
        </div>
        <div class="views_box hide">
            <div class="views_text left"><input name="" type="text"></div>
            <div class="views_btn left"><input name="" type="button" value="发送" onclick="fasong();"></div>
        </div>
    </div>
    <script type="text/javascript">
        function GetRequest() {
            var url = location.search; //获取url中"?"符后的字串
            var theRequest = new Object();
            if (url.indexOf("?") != -1) {
                var str = url.substr(1);
                strs = str.split("&");
                for (var i = 0; i < strs.length; i++) {
                    theRequest[strs[i].split("=")[0]] = unescape(strs[i].split("=")[1]);
                }
            }
            return theRequest;
        }
        var colors = new Array(11);
        colors[0] = "255, 255, 255",
        colors[3] = "255, 111, 83",
        colors[2] = "196, 152, 255",
        colors[4] = "89, 224, 232",
        colors[5] = "255, 129, 176",
        colors[1] = "255, 178, 95",
        colors[8] = "214, 249, 93",
        colors[6] = "55, 147, 255",
        colors[7] = "121, 183, 54",
        colors[10] = "240, 70, 96",
        colors[9] = "205,133,63";
        var images = new Array(11);
        images[1] = '',
        images[1] = '<img style="height: 20px;" src="http://cache.j3ui.com/icon/playeravatar/sl.png">',
        images[2] = '<img style="height: 20px;" src="http://cache.j3ui.com/icon/playeravatar/wh.png">',
        images[3] = '<img style="height: 20px;" src="http://cache.j3ui.com/icon/playeravatar/tc.png">',
        images[4] = '<img style="height: 20px;" src="http://cache.j3ui.com/icon/playeravatar/cy.png">',
        images[5] = '<img style="height: 20px;" src="http://cache.j3ui.com/icon/playeravatar/qx.png">',
        images[6] = '<img style="height: 20px;" src="http://cache.j3ui.com/icon/playeravatar/wd.png">',
        images[7] = '<img style="height: 20px;" src="http://cache.j3ui.com/icon/playeravatar/tm.png">',
        images[8] = '<img style="height: 20px;" src="http://cache.j3ui.com/icon/playeravatar/cj.png">',
        images[9] = '<img style="height: 20px;" src="http://cache.j3ui.com/icon/playeravatar/gb.png">',
        images[10] = '<img style="height: 20px;" src="http://cache.j3ui.com/icon/playeravatar/mj.png">';
        jQuery(document).ready(function () {
            var Request = new Object();
            Request = GetRequest();
            var tid = Request['tid'];
            var url = "http://msg.j3ui.com:10200/replylist.php"
            $.ajax({
                url: "./Data/getConfigData.aspx",
                type: "post",
                dataType: "json",
                data: "&ajaxurl=" + url + "&tid=" + tid + "&_=" + new Date().getTime(),
                success: function (data) {
                    //LoadEnd();
                    //var ss = JSON.stringify(data.data);
                    var ss = data.content;
                    //alert(ss);
                    $(".hudong_tit").html(ss.substr(0,8)+"....");
                    if (data.data != null) {
                        for (var i = data.data.length - 1; i >= 0; i--) {
                            var text = data.data[i]["m"];
                            var author = data.data[i]["a"];
                            var time = TimeToDate(data.data[i]["t"]);
                            $('<div class="views_time"> ' + time + '</div><div class="views_1"> <dl> <dt>' + images[data.data[i]["s"]] + author + '：</dt> <dd><em></em>' + text + '</dd> </dl> </div> <div class="clear"></div>').appendTo("#liaotian");
                            setTimeout(function () { scrollviews.refresh(); }, 200);
                            setTimeout(function () { scrollviews.scrollToElement('div.clear:last-child', 0); }, 210);
                        }
                    }
                    else
                    {
                        $(".hudong_tit").html(ss.substr(0, 8) + "....");
                        //var text = data.data["m"];
                        //var author = data.data["a"];
                        //var time = TimeToDate(data.data["t"]);
                        //$('<div class="views_time"> ' + time + '</div><div class="views_1"> <dl> <dt style="color:rgb(' + colors[data.data["s"]] + ')">' + author + '：</dt> <dd><em></em>' + text + '</dd> </dl> </div> <div class="clear"></div>').appendTo("#liaotian");
                        //setTimeout(function () { scrollviews.refresh(); }, 200);
                        //setTimeout(function () { scrollviews.scrollToElement('div.clear:last-child', 0); }, 210);
                    }
                }
            })

        });

    </script>
</body>
</html>